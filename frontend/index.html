<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CBMPE - Centro de Controle</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary: #b13433;
        --secondary: #b13433;
        --bg: #f5f7fa;
        --card-bg: #ffffff;
        --text: #000000;
      }

      element.style {
        color: none;
        margin: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: var(--bg);
        color: var(--text);
      }

      h1,
      h2,
      h3 {
        color: var(--primary);
        margin-top: 0;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .card {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border-top: 4px solid var(--primary);
      }

      .kpi-card {
        background: var(--primary);
        color: white;
        text-align: center;
        grid-column: 1 / -1;
      }
      .kpi-card h1 {
        color: white;
        font-size: 3.5rem;
        margin: 10px 0;
      }
      .kpi-card h3 {
        color: white;
      }

      .kpi-card p {
        opacity: 0.8;
        font-size: 1.1rem;
      }

      .predicao-section {
        grid-column: 1 / -1;
        margin-top: 30px;
        border-top: 4px solid var(--secondary);
      }

      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      .radio-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .radio-item {
        background: #eee;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.9em;
        cursor: pointer;
        display: flex;
        align-items: center;
      }
      .radio-item:hover {
        background: #ddd;
      }
      input[type="radio"] {
        margin-right: 5px;
      }

      input[type="number"] {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 100px;
      }

      button {
        background-color: var(--secondary);
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 1em;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }
      button:hover {
        background-color: #d35400;
      }

      .resultado-box {
        color: var(--primary);
        margin-top: 15px;
        padding: 15px;
        background: #eef2f7;
        border-radius: 5px;
        text-align: center;
      }

      canvas {
        max-height: 300px;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-grid">
      <div style="grid-column: 1 / -1; text-align: center; margin-bottom: 10px">
        <h1>Central de Operações - CBMPE</h1>
      </div>

      <div class="card kpi-card">
        <h3>Total de Ocorrências</h3>
        <h1 id="kpiTotal">...</h1>
        <p>Dados atualizados em tempo real</p>
      </div>

      <div class="card">
        <h3>Distribuição por Natureza</h3>
        <canvas id="graficoNatureza"></canvas>
      </div>

      <div class="card">
        <h3>Top 5 Bairros (Maior Demanda)</h3>
        <canvas id="graficoBairros"></canvas>
      </div>

      <div class="card">
        <h3>Situação das Vítimas</h3>
        <canvas id="graficoVitimas"></canvas>
      </div>

      <div class="card predicao-section">
        <h2 style="color: var(--secondary)">
          IA Preditiva: Classificador de Ocorrências
        </h2>
        <p>
          Simule o gênero da vítima e o local para prever a o grupo e subgrupo
          provável da Ocorrência.
        </p>

        <form id="form-predizer">
          <div class="form-group">
            <label>Gênero da Vítima:</label>
            <div id="generoRadios" class="radio-group">Carregando...</div>
          </div>

          <div class="form-group">
            <label>Localização (Bairro):</label>
            <div id="localizacaoRadios" class="radio-group">Carregando...</div>
          </div>

          <div class="form-group">
            <label for="idade">Idade Aproximada:</label>
            <input
              type="number"
              id="idade"
              required
              min="1"
              max="120"
              value="30"
            />
          </div>

          <button type="submit">Prever</button>
        </form>

        <div id="resultado" class="resultado-box">
          <em>O resultado da previsão aparecerá aqui...</em>
        </div>
      </div>
    </div>

    <script>
      const cores = {
        azul: "#40516c",
        laranja: "#e67e22",
        verde: "#2ecc71",
        vermelho: "#b13433",
        palette: [
          "#40516c",
          "#e67e22",
          "#2ecc71",
          "#e74c3c",
          "#9b59b6",
          "#34495e",
        ],
      }

      let chartNatureza = null
      let chartBairros = null
      let chartVitimas = null

      // --- 1. Carregar Dashboard ---
      async function carregarDashboard() {
        try {
          const response = await fetch(
            "http://127.0.0.1:5000/api/dashboard/stats"
          )
          if (!response.ok) throw new Error("Falha na API")
          const stats = await response.json()

          document.getElementById("kpiTotal").innerText = stats.kpi_total

          renderizarNatureza(stats.natureza_ocorrencias)
          renderizarBairros(stats.top_bairros)
          renderizarVitimas(stats.situacao_vitimas)
        } catch (error) {
          console.error("Erro:", error)
          document.getElementById("kpiTotal").innerText = "Erro"
        }
      }

      function renderizarNatureza(dados) {
        const ctx = document.getElementById("graficoNatureza").getContext("2d")
        if (chartNatureza) chartNatureza.destroy()
        chartNatureza = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: dados.labels,
            datasets: [
              {
                data: dados.series,
                backgroundColor: cores.palette,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "bottom" } },
          },
        })
      }

      function renderizarBairros(dados) {
        const ctx = document.getElementById("graficoBairros").getContext("2d")
        if (chartBairros) chartBairros.destroy()
        chartBairros = new Chart(ctx, {
          type: "bar",
          indexAxis: "y",
          data: {
            labels: dados.labels,
            datasets: [
              {
                label: "Ocorrências",
                data: dados.series,
                backgroundColor: cores.vermelho,
                borderRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
          },
        })
      }

      function renderizarVitimas(dados) {
        const ctx = document.getElementById("graficoVitimas").getContext("2d")
        if (chartVitimas) chartVitimas.destroy()
        chartVitimas = new Chart(ctx, {
          type: "bar",
          data: {
            labels: dados.labels,
            datasets: [
              {
                label: "Total",
                data: dados.series,
                backgroundColor: [cores.vermelho, cores.verde],
                barThickness: 50,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
          },
        })
      }

      // --- 2. Carregar Opções ---
      async function carregarOpcoes() {
        try {
          const res = await fetch("http://127.0.0.1:5000/api/opcoes")
          const data = await res.json()

          // GÊNERO
          const generoDiv = document.getElementById("generoRadios")
          generoDiv.innerHTML = ""
          if (data.generos) {
            data.generos.forEach((opt, i) => {
              generoDiv.innerHTML += `
                            <label class="radio-item">
                                <input type="radio" name="genero" value="${opt}" ${
                i === 0 ? "checked" : ""
              }> ${opt}
                            </label>`
            })
          } else {
            generoDiv.innerHTML = "Erro ao carregar gêneros"
          }

          // LOCALIZAÇÃO
          const localDiv = document.getElementById("localizacaoRadios")
          localDiv.innerHTML = ""
          data.locais.forEach((opt, i) => {
            localDiv.innerHTML += `
                        <label class="radio-item">
                            <input type="radio" name="localizacao" value="${opt}" ${
              i === 0 ? "checked" : ""
            }> ${opt}
                        </label>`
          })
        } catch (error) {
          console.error("Erro ao carregar opções:", error)
        }
      }

      // --- 3. Enviar Predição ---
      document.getElementById("form-predizer").onsubmit = async function (e) {
        e.preventDefault()
        const resDiv = document.getElementById("resultado")
        resDiv.innerHTML = "Calculando probabilidade..."

        const generoInput = document.querySelector(
          'input[name="genero"]:checked'
        )
        const localInput = document.querySelector(
          'input[name="localizacao"]:checked'
        )
        const idadeInput = document.getElementById("idade")

        if (!generoInput || !localInput) {
          resDiv.innerHTML = "Aguarde o carregamento das opções."
          return
        }

        const dados = {
          genero: generoInput.value,
          localizacao: localInput.value,
          idade: parseInt(idadeInput.value),
        }

        try {
          const response = await fetch("http://127.0.0.1:5000/api/predizer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dados),
          })
          const result = await response.json()

          if (result.classe_predita) {
            const prob = (result.confianca * 100).toFixed(1)

            resDiv.innerHTML = `
                        <h3 style="color: ${cores.vermelho}; margin:0;">${
              result.classe_predita
            }</h3>
                        <p>Probabilidade: <strong>${prob}%</strong></p>
                        <small style="color: ${cores.laranja};">${
              result.aviso || ""
            }</small>
                    `
          } else {
            resDiv.innerHTML = `<span style="color:red">Erro: ${result.erro}</span>`
          }
        } catch (error) {
          resDiv.innerHTML = "Erro de conexão com o servidor."
        }
      }

      window.onload = function () {
        carregarDashboard()
        carregarOpcoes()
      }
    </script>
  </body>
</html>
